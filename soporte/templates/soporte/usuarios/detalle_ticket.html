{% extends 'soporte/app.html' %}
{% load static %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<style>

/* en tu bloque <style> existente */
.msg-attachment {
  max-height: 50px;
  margin: .25rem;
  border-radius: .25rem;
  object-fit: cover;
}

  /* 1) Quita el borde fijo del contenedor */
.msg-container {
  position: relative;
}

/* 2) Dale el borde y el fondo blanco al textarea, no al .msg-container */
.msg-container textarea {
  width: 100%;
  border: 1px solid #ced4da;
  border-radius: .25rem;
  padding: .5rem;
  box-sizing: border-box;
  resize: vertical;
  background: #fff;
  position: relative;
  z-index: 2;
}

/* 3) Esconde la dropzone hasta que arrastres algo */
.dropzone {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  border: 2px dashed #555;
  border-radius: .25rem;
  background: rgba(0,0,0,0.05);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #888;
  font-size: .9rem;
  transition: background .2s, border-color .2s, opacity .2s;
  opacity: 0;
  pointer-events: none;
  z-index: 1;
}

/* 4) Sólo al arrastrar, la haces visible */
.msg-container.dragover .dropzone {
  opacity: 1;
}

/* lista de ficheros sólo si hay ficheros (se rellena por JS) */
.file-list { margin-top:.5rem; font-size:.85rem; }
.file-list li { list-style:none; }

</style>
{% endblock %}

{% block title %}Detalle de Ticket{% endblock %}

{% block content %}
<div class="container py-5">
  <a href="{% url 'soporte:dashboard_usuario' %}" class="btn btn-secondary mb-4">← Volver</a>

  {# === BLOQUE DETALLE ===#}
  <div class="code-container mb-5">
    <div class="header">
            <div class="top">
              <div class="circle"><span class="red circle2"></span></div>
              <div class="circle"><span class="yellow circle2"></span></div>
              <div class="circle"><span class="green circle2"></span></div>
    <div class="title">
      <p id="title2">Número de Ticket: {{ ticket.id }}</p>
    </div>  
    </div><br>
    </div>
    <pre class="code">
<span class="var">Título</span>= <span class="val">'{{ ticket.titulo|escapejs }}'</span>
<span class="var">Estado</span>= <span class="val">'{{ ticket.estado.nombre }}'</span>
<span class="var">Usuario</span>= <span class="val">'{{ ticket.creado_por.username }}'</span>
<span class="var">Sucursal</span>= <span class="val">'{{ ticket.creado_por.sucursal.nombre|escapejs }}'</span>
<span class="var">Nombre</span>= <span class="val">'{{ ticket.creado_por.first_name }}'</span>
<span class="var">Apellido</span>= <span class="val">'{{ ticket.creado_por.last_name }}'</span>
<span class="var">Estado</span>= <span class="val">'{{ ticket.estado.nombre }}'</span>
<span class="var">Agente asignado</span>= <span class="val">'{{ ticket.asignado_a.first_name }}'</span><br>
<span class="var">Creado</span>= <span class="val">'{{ ticket.fecha_creado|date:"Y-m-d H:i" }}'</span>
<span class="var">Actualizado</span>= <span class="val">'{{ ticket.fecha_actualizado|date:"Y-m-d H:i" }}'</span>
{% if ticket.motivo_anulacion %}
<span class="var">Motivo anulación</span>= <span class="val">'{{ ticket.motivo_anulacion|escapejs }}'</span>
{% endif %}
{% if ticket.estado.nombre == 'Reabierto' %}
<span class="var">Motivo reapertura</span>= <span class="val">'{{ ticket.motivo_reapertura|escapejs }}'</span>
{% endif %}
<span class="var">Descripción</span>= <span class="val">'{{ ticket.descripcion|default:"— sin descripción —"|escapejs }}'</span>
    </pre>

            <!-- Miniatura si existe -->
    {% if ticket.imagenes.exists %}
      <div class="px-2 pt-2">
        <img src="{{ ticket.imagenes.all.0.imagen.url }}"
          class="img-fluid rounded"        
          style="max-height:80px; object-fit:cover;">
      </div>
    {% endif %}  
  </div>

  <h6 class="dashboard-subtitle">Mensajes</h6>
  <div class="overflow-auto mb-5" style="max-height:50vh;">
    {% for m in mensajes %}
      <div class="code-container mb-3">
        <div class="header">
          <div class="top">
            <div class="circle"><span class="red circle2"></span></div>
            <div class="circle"><span class="yellow circle2"></span></div>
            <div class="circle"><span class="green circle2"></span></div>
            <div class="title"><p id="title2">{{ m.emisor.get_full_name|default:m.emisor.username }}</p></div>
          </div>
        </div>
        <div class="code-container">
          <pre class="code">
<span class="var">De</span>= <span class="val">'{{ m.emisor.username }}'</span>
<span class="var">Para</span>= <span class="val">'{{ m.receptor.username }}'</span>
<span class="var">Fecha</span>= <span class="val">'{{ m.fecha_envio|date:"Y-m-d H:i" }}'</span>
<span class="var">Mensaje</span>= <span class="val">'{{ m.contenido|escapejs }}'</span>
          </pre>

          {% if m.attachments.count %}
    <div class="d-flex flex-wrap">
      {% for att in m.attachments.all %}
  {% with url=att.file.url %}
  {% with ext4=url|lower|slice:"-4:" ext5=url|lower|slice:"-5:" %}
    {% comment %} Mostrar miniatura solo para imágenes {% endcomment %}
    {% if ext4 in ".png .jpg .gif .webp" or ext5 == ".jpeg" %}
      <a href="{{ url }}" target="_blank" class="me-2 mb-2">
      <img src="{{ url }}" class="msg-attachment" alt="Imagen adjunta {{ forloop.counter }}">
      </a>

    {% comment %} Archivos “previsualizables” (PDF) – podrías usar un icono distinto {% endcomment %}
    {% elif ext4 == ".pdf" %}
      <div class="me-2 mb-2 px-2 py-1 bg-secondary text-white small rounded">
        <i class="fas fa-file-pdf"></i>
        <a href="{{ url }}" target="_blank" class="text-white">
          {{ att.file.name|slice:"-20:" }}
        </a>
      </div>
      {% elif ext4 == ".webp" %}
                      <div class="me-2 mb-2 px-2 py-1 bg-secondary text-white small rounded">
                        <i class="fas fa-file-webp"></i>
                        <a href="{{ url }}" target="_blank" class="text-white">
                          {{ att.file.name|slice:"-20:" }}
                        </a>
                      </div>

    {% comment %} Word {% endcomment %}
    {% elif ext5 == ".docx" or ext4 == ".doc" %}
      <div class="me-2 mb-2 px-2 py-1 bg-secondary text-white small rounded">
        <i class="fas fa-file-word"></i>
        <a href="{{ url }}" target="_blank" class="text-white">
          {{ att.file.name|slice:"-20:" }}
        </a>
      </div>

    {% comment %} Excel {% endcomment %}
    {% elif ext5 == ".xlsx" or ext4 == ".xls" %}
      <div class="me-2 mb-2 px-2 py-1 bg-secondary text-white small rounded">
        <i class="fas fa-file-excel"></i>
        <a href="{{ url }}" target="_blank" class="text-white">
          {{ att.file.name|slice:"-20:" }}
        </a>
      </div>

    {% comment %} CSV {% endcomment %}
    {% elif ext4 == ".csv" %}
      <div class="me-2 mb-2 px-2 py-1 bg-secondary text-white small rounded">
        <i class="fas fa-file-csv"></i>
        <a href="{{ url }}" target="_blank" class="text-white">
          {{ att.file.name|slice:"-20:" }}
        </a>
      </div>

    {% comment %} Cualquier otro archivo {% endcomment %}
    {% else %}
      <div class="me-2 mb-2 px-2 py-1 bg-secondary text-white small rounded">
        <i class="fas fa-file"></i>
        <a href="{{ url }}" target="_blank" class="text-white">
          {{ att.file.name|slice:"-20:" }}
        </a>
      </div>
    {% endif %}
  {% endwith %}
  {% endwith %}
{% endfor %}
    </div>
  {% else %}
    <p class="text-muted small">No hay archivos adjuntos.</p>
  {% endif %}

          {# Texto #}
          {% if m.contenido %}
            <div class="mt-2">{{ m.contenido }}</div>
          {% endif %}
        </div>
      </div>
    {% empty %}
      <p class="text-muted">No hay mensajes aún.</p>
    {% endfor %}
  </div>

  {# … recién aquí el formulario de envío … #}
  {% if ticket.asignado_a and ticket.estado_id != 3 %}
    <div class="mb-5">
      <form method="post" enctype="multipart/form-data" id="msgForm">
        {% csrf_token %}
       <div class="msg-container mb-2">
  {{ form.contenido }}
  <input
    type="file"
    id="fileInput"
    name="attachments"
    multiple="true"
    hidden>
  <ul id="fileList" class="file-list"></ul>
</div>
<button type="button" id="attachBtn" class="btn btn-secondary btn-sm me-2">
  <i class="fas fa-paperclip"></i> Adjuntar
</button>
        <button type="submit" class="btn btn-primary btn-sm me-2">
          <i class="fas fa-paper-plane me-1"></i> Enviar
        </button>
      </form>
    </div>
  {% endif %}

  
  {# === BOTÓN SCROLL-TO-TOP === #}
  <button id="scrollTopBtn"
          class="btn btn-secondary position-fixed"
          style="bottom:30px; right:30px; z-index:1000; display:none;"
          aria-label="Arriba">↑</button>
</div>



<script>
document.addEventListener('DOMContentLoaded', ()=> {
  // Scroll-to-top
  const btn = document.getElementById('scrollTopBtn');
  window.addEventListener('scroll', ()=> btn.style.display = window.pageYOffset>200?'block':'none');
  btn.addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}));

})

document.addEventListener('DOMContentLoaded', ()=> {
  const msgCon   = document.querySelector('.msg-container');
  const inp      = document.getElementById('fileInput');
  const list     = document.getElementById('fileList');
  const attach   = document.getElementById('attachBtn');

  // clic en el clip abre el file input
  attach.addEventListener('click', () => inp.click());

  // al cambiar por el file picker
  inp.addEventListener('change', () => updateList(Array.from(inp.files)));

  // estilos de arrastre
  ['dragover','dragenter'].forEach(ev =>
    msgCon.addEventListener(ev, e => {
      e.preventDefault();
      msgCon.classList.add('dragover');
    })
  );
  msgCon.addEventListener('dragleave', e => {
    e.preventDefault();
    msgCon.classList.remove('dragover');
  });

  // al soltar
  msgCon.addEventListener('drop', e => {
    e.preventDefault();
    msgCon.classList.remove('dragover');
    const files = Array.from(e.dataTransfer.files);
    // volcamos al input
    const dt = new DataTransfer();
    files.forEach(f => dt.items.add(f));
    inp.files = dt.files;
    updateList(files);
  });

  function updateList(files) {
    list.innerHTML = '';
    if (!files.length) {
      list.insertAdjacentHTML('beforeend','<li class="text-muted">No hay archivos</li>');
    } else {
      files.forEach(f => {
        const li = document.createElement('li');
        li.textContent = f.name;
        list.appendChild(li);
      });
    }
  }
});
</script>

{% endblock %}