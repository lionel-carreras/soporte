{% extends 'soporte/app.html' %}
{% load static %}

{% block title %}Impresoras · Inventario{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">Inventario de impresoras</h4>
  <a href="{% url 'inventario:impresora_create' %}" class="btn btn-primary btn-sm">
    <i class="fa fa-plus me-1"></i> Nueva
  </a>
</div>

<form method="get" class="row g-2 align-items-end mb-3">
  <div class="col-sm-4">
    <label class="form-label mb-0">Buscar</label>
    <input class="form-control" name="q" value="{{ f.q }}" placeholder="Marca, modelo, serie o IP">
  </div>

  <div class="col-sm-3">
    <label class="form-label mb-0">Sucursal</label>
    <select class="form-select" name="sucursal">
      <option value="">— Todas —</option>
      {% for s in sucursales %}
        <option value="{{ s.id }}" {% if f.sucursal == s.id|stringformat:"s" %}selected{% endif %}>
          {{ s.nombre }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-sm-2">
    <label class="form-label mb-0">Propiedad</label>
    <select class="form-select" name="propiedad">
      <option value="">— Cualquiera —</option>
      {% for val,label in choices.propiedad %}
        <option value="{{ val }}" {% if f.propiedad == val %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-sm-1">
    <label class="form-label mb-0">Activa</label>
    <select class="form-select" name="activa">
      <option value="">Todas</option>
      <option value="1" {% if f.activa == "1" %}selected{% endif %}>Sí</option>
      <option value="0" {% if f.activa == "0" %}selected{% endif %}>No</option>
    </select>
  </div>

  <div class="col-12 d-flex gap-2">
    <button class="btn btn-primary btn-sm"><i class="fa fa-filter me-1"></i> Filtrar</button>
    <a class="btn btn-outline-secondary btn-sm" href="?"><i class="fa fa-eraser me-1"></i> Limpiar</a>
  </div>
</form>

<div class="table-responsive">
  <table class="table table-striped table-hover table-sm align-middle">
    <thead>
      <tr>
        <th>Sucursal</th>
        <th>Marca</th>
        <th>Modelo</th>
        <th>N° Serie</th>
        <th>Conexión</th>
        <th>IP / PC</th>
        <th>Propiedad</th>
        <th>Activa</th>
        <th>Sector</th>
        <th>Toner </th>
        <th class="text-end">Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for imp in page_obj %}
      <tr>
        <td>{{ imp.sucursal.nombre }}</td>
        <td>{{ imp.marca }}</td>
        <td>{{ imp.modelo }}</td>
        <td>{{ imp.nro_serie }}</td>
        <td><span class="badge text-bg-light">{{ imp.conexion }}</span></td>
        <td>{{ imp.ip|default:"—" }}</td>
        <td>
          {% if imp.propiedad == "PROPIA" %}
            <span class="badge text-bg-success">Propia</span>
          {% else %}
            <span class="badge text-bg-warning">Alquiler</span>
          {% endif %}
        </td>
        <td>
          {% if imp.activa %}
            <i class="fa fa-check text-success"></i>
          {% else %}
            <i class="fa fa-xmark text-danger"></i>
          {% endif %}
        </td>
        <td>{{ imp.ubicacion|default:"—" }}</td>
        <td>{{ imp.toner|default:"—" }}</td>
        <td class="text-end">
          <a class="btn btn-outline-primary btn-sm" href="{% url 'inventario:impresora_edit' imp.id %}"><i class="fa fa-pen"></i></a>
          <a class="btn btn-outline-secondary btn-sm" href="{% url 'inventario:impresora_detail' imp.id %}"><i class="fa fa-eye"></i></a>
          <a class="btn btn-outline-danger btn-sm" href="{% url 'inventario:impresora_delete' imp.id %}"><i class="fa fa-trash"></i></a>

          <!-- Botón que abre el modal global -->
          <button type="button"
                class="btn btn-outline-dark btn-sm"
                data-bs-toggle="modal"
                data-bs-target="#qrModal"
                data-title="{{ imp.marca }} {{ imp.modelo }}"
                data-qr-src="{% url 'inventario:impresora_qr' imp.id %}?v={{ imp.updated_at|date:'U' }}"
                data-public-url="{% url 'inventario:impresora_public_detail' imp.id %}">
        <i class="fa fa-qrcode"></i>
        </button>

        </td>
      </tr>
      {% empty %}
      <tr><td colspan="9" class="text-center py-4">Sin resultados.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if page_obj.paginator.num_pages > 1 %}
<nav aria-label="Paginación" class="mt-3">
  <!-- (tu paginación tal cual) -->
</nav>
{% endif %}

<!-- Modal único (sin usar 'imp' acá) -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header py-2">
        <h6 class="modal-title" id="qrModalTitle">QR</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body text-center">
        <img id="qrImg" src="" alt="QR" class="img-fluid" style="image-rendering: pixelated;">
        <p>Soporte IT Expreso Brio </p>
      </div>
      <div class="modal-footer py-2">
        <a id="qrDownload" class="btn btn-outline-secondary btn-sm" target="_blank" href="">Descargar PNG</a>
        <button type="button" class="btn btn-primary btn-sm" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const modalEl = document.getElementById('qrModal');
  if (!modalEl) return;

  modalEl.addEventListener('show.bs.modal', function (ev) {
    const btn = ev.relatedTarget;                  // botón que abrió el modal
    if (!btn) return;

    const title  = btn.getAttribute('data-title') || 'QR';
    const qrSrc  = btn.getAttribute('data-qr-src');
    const pubUrl = btn.getAttribute('data-public-url');

    // poblar elementos
    document.getElementById('qrModalTitle').textContent = `QR – ${title}`;
    document.getElementById('qrImg').src = qrSrc;


    const download = document.getElementById('qrDownload');
    const href = qrSrc + (qrSrc.includes('?') ? '&' : '?') + 'download=1';
    download.href = href;
    // sugerir nombre (navegadores que soportan)
    const safe = title.replace(/\s+/g,'_').replace(/[^\w\-]/g,'');
    download.setAttribute('download', `QR-${safe}.png`);
  });
});
</script>
{% endblock %}


